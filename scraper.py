import json
import os
import time
import random
import pandas as pd
from curl_cffi import requests
from datetime import datetime

# ‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶∞‡¶ø ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
os.makedirs('data', exist_ok=True)
os.makedirs('reports', exist_ok=True)

class WingoEnterprise:
    def __init__(self):
        self.url = "https://draw.ar-lottery01.com/WinGo/WinGo_30S/GetHistoryIssuePage.json"
        self.file_path = "data/wingo_master_history.json"
        # ‡¶¨‡¶ø‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶Æ ‡¶ö‡ßü‡ßá‡¶∏ (‡¶¨‡¶ü ‡¶°‡¶ø‡¶ü‡ßá‡¶ï‡¶∂‡¶® ‡¶è‡ßú‡¶æ‡¶§‡ßá)
        self.impersonates = ["chrome110", "chrome120", "edge101", "safari_ios_16_0"]

    def get_dynamic_headers(self):
        return {
            "Accept": "application/json, text/plain, */*",
            "Content-Type": "application/json;charset=UTF-8",
            "User-Agent": f"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/{random.randint(110, 122)}.0.0.0 Safari/537.36",
            "X-Requested-With": "XMLHttpRequest",
            "Origin": "https://draw.ar-lottery01.com",
            "Referer": "https://draw.ar-lottery01.com/"
        }

    def fetch_data(self):
        payload = {"pageIndex": 1, "pageSize": 50, "type": 30}
        
        try:
            # ‡¶∏‡ßá‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶ï‡ßÅ‡¶ï‡¶ø ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤ ‡¶ï‡¶∞‡¶æ
            with requests.Session() as s:
                response = s.post(
                    self.url,
                    json=payload,
                    headers=self.get_dynamic_headers(),
                    impersonate=random.choice(self.impersonates),
                    timeout=30
                )
            
            if response.status_code == 200:
                raw_res = response.json()
                if 'data' in raw_res:
                    return raw_res['data']['list']
            print(f"Warning: Status Code {response.status_code}")
            return None
        except Exception as e:
            print(f"Critical Error: {e}")
            return None

    def process_and_analyze(self, new_data):
        if not new_data: return

        # ‡¶≤‡ßã‡¶° ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶°‡¶æ‡¶ü‡¶æ
        history = []
        if os.path.exists(self.file_path):
            with open(self.file_path, "r") as f:
                history = json.load(f)

        # ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú ‡¶ï‡¶∞‡¶æ
        existing_ids = {str(x['issueNumber']) for x in history}
        updated = False
        for item in new_data:
            if str(item['issueNumber']) not in existing_ids:
                history.append(item)
                updated = True

        if not updated:
            print("No new trends found.")
            return

        # ‡¶∏‡¶∞‡ßç‡¶ü‡¶ø‡¶Ç (‡¶≤‡ßá‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶ó‡ßá)
        history = sorted(history, key=lambda x: str(x['issueNumber']), reverse=True)[:20000]

        with open(self.file_path, "w") as f:
            json.dump(history, f, indent=2)

        self.generate_market_report(history)

    def generate_market_report(self, history):
        """‡¶°‡¶æ‡¶ü‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡ßá‡¶ü ‡¶ü‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶∏‡¶ø‡¶∏ ‡¶ï‡¶∞‡¶æ"""
        df = pd.DataFrame(history)
        
        # ‡¶≤‡ßá‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡ßß‡ß¶‡¶ü‡¶ø ‡¶°‡ßç‡¶∞-‡¶è‡¶∞ ‡¶ü‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶°
        latest_results = df.head(10)[['issueNumber', 'number', 'colour']].to_markdown()
        
        # ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶´‡ßç‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶®‡ßç‡¶∏‡¶ø
        color_counts = df.head(100)['colour'].value_counts().to_dict()
        
        report = f"""
# üìä Wingo Enterprise Market Intelligence Report
**Last Updated:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

### üöÄ Recent Draw History (Top 10)
{latest_results}

### üìà Probability Analysis (Last 100 Draws)
- **Red:** {color_counts.get('red', 0)}%
- **Green:** {color_counts.get('green', 0)}%
- **Violet:** {color_counts.get('violet', 0)}%

---
*Generated by Wingo-AI-Bot (v2.0)*
        """
        with open("reports/market_summary.md", "w") as f:
            f.write(report)
        print("Report Generated Successfully.")

if __name__ == "__main__":
    bot = WingoEnterprise()
    # ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶ì‡ßü‡ßá‡¶ü
    time.sleep(random.uniform(2.5, 7.5))
    data = bot.fetch_data()
    bot.process_and_analyze(data)
                
